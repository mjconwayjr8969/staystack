<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StayStack</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel so we can write JSX in this single file -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
  <!-- Optional: EmailJS SDK (only used if you configure keys in Settings) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    html,body { height: 100%; }
    .line-clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  </style>
</head>
<body class="bg-white text-slate-900">
  <div id="app"></div>

  <script type="text/babel">
  const { useState, useMemo, useEffect } = React;

  // -------------------- Utilities --------------------
  const LS_KEY = 'staystack_v3';
  const REMOTE_URL = '/.netlify/functions/state';

  const uid = (p='id') => p + Math.random().toString(36).slice(2,8)+Date.now().toString(36).slice(-4);

  const readFileAsDataURL = (file) => new Promise((res,rej)=>{
    const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
  });

  const toAmen = (s) => Array.isArray(s) ? s : String(s||'').split(',').map(x=>x.trim()).filter(Boolean);
  const safeAmen = (a) => Array.isArray(a) ? a.filter(Boolean) : toAmen(a);

  const toImages = (legacyImage) => legacyImage ? [legacyImage] : [];

  const nightsBetween = (a,b)=>{
    try{
      const A=new Date(a), B=new Date(b);
      return Math.max(0, Math.round((B-A)/(1000*60*60*24)));
    }catch{return 0}
  };
  const rangesOverlap=(a1,a2,b1,b2)=> new Date(a1)<new Date(b2) && new Date(b1)<new Date(a2);

  // -------------------- Default Data --------------------
  const DEMO_PROPERTIES = [
    { id:uid('p'), title:"MAMA J'S Downeast", location:'Milbridge Maine', beds:5, baths:1, maxGuests:8, pricePerNight:400,
      amenities:['Wi-Fi','Ocean View','Deck','Grill'],
      description:`Absolutely—here’s polished, paste‑ready copy for your listing at Ray’s Point, Milbridge, ME. I used the working name from your app (you can swap it out). If…`,
      images:[
        'https://images.unsplash.com/photo-1505691723518-36a5ac3b2b8f?q=80&w=1600&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1501183638710-841dd1904471?q=80&w=1600&auto=format&fit=crop',
        'https://images.unsplash.com/photo-1505691723518-36a5ac3b2b8f?q=80&w=1600&auto=format&fit=crop'
      ]
    }
  ];

  const DEFAULT_STATE = {
    role:'Guest',
    view:'browse',
    settings:{ brand:'Downeast Getaway', email:{ enabled:false, publicKey:'', serviceId:'', templateId:'', managerEmail:'' }, sms:{ enabled:false, managerPhone:'' } },
    properties: DEMO_PROPERTIES,
    bookings: [],
    notifications: [],
    requests: [],
    filters:{ start:'', end:'', guests:1 }
  };

  // -------------------- Image Carousel --------------------
  function ImageCarousel({ images = [], ratio = "16 / 10", rounded = "", fit = "cover" }){
    const list = images.filter(Boolean);
    const [i, setI] = React.useState(0);
    const len = Math.max(1, list.length);
    const go = (d) => setI(v => (v + d + len) % len);

    // simple swipe
    const [sx, setSx] = React.useState(null);
    const onTouchStart = (e) => setSx(e.changedTouches[0].clientX);
    const onTouchEnd = (e) => {
      if (sx == null) return;
      const dx = e.changedTouches[0].clientX - sx;
      if (Math.abs(dx) > 40) go(dx < 0 ? 1 : -1);
      setSx(null);
    };

    const src = list[i] || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

    return (
      <div
        className={`w-full relative ${rounded} overflow-hidden bg-slate-100`}
        style={{ aspectRatio: ratio }}
        onTouchStart={onTouchStart}
        onTouchEnd={onTouchEnd}
      >
        <img
          src={src}
          alt=""
          className={`w-full h-full ${fit === "contain" ? "object-contain" : "object-cover"} object-center`}
          loading="lazy"
        />
        {len > 1 && (
          <>
            <button
              className="absolute left-2 top-1/2 -translate-y-1/2 h-8 w-8 rounded-full bg-white/70 flex items-center justify-center"
              onClick={() => go(-1)}
            >&lt;</button>
            <button
              className="absolute right-2 top-1/2 -translate-y-1/2 h-8 w-8 rounded-full bg-white/70 flex items-center justify-center"
              onClick={() => go(1)}
            >&gt;</button>
            <div className="absolute bottom-2 w-full flex justify-center gap-1">
              {list.map((_, idx) => (
                <div key={idx} className={`h-1.5 w-1.5 rounded-full ${idx === i ? "bg-white" : "bg-white/50"}`} />
              ))}
            </div>
          </>
        )}
      </div>
    );
  }

  // -------------------- Booking Modal -------------------- --------------------
  function openBookingDialog({ state,setState,property }){
    const host=document.createElement('div');
    document.body.appendChild(host);
    const prevOverflow=document.body.style.overflow; document.body.style.overflow='hidden';
    const root=ReactDOM.createRoot(host);
    const close=()=>{ try{ root.unmount(); }catch{} document.body.style.overflow=prevOverflow; host.remove(); };

    function BookingModal(){
      const [from,setFrom]=useState(state.filters.start||'');
      const [to,setTo]=useState(state.filters.end||'');
      const [guests,setGuests]=useState(state.filters.guests||1);
      const [name,setName]=useState('');
      const [email,setEmail]=useState('');
      const [note,setNote]=useState('');
      const [payment,setPayment]=useState('card');
      const nights=useMemo(()=> (from&&to)? nightsBetween(from,to):0, [from,to]);
      const total=nights*property.pricePerNight;
      const conflicting=useMemo(()=> !from||!to?false : state.bookings.some(b=> b.propertyId===property.id && b.status!=='declined' && b.status!=='cancelled' && rangesOverlap(b.from,b.to,from,to)), [from,to,state.bookings]);

      // Email helper (optional)
      const sendEmails = async (booking) => {
        const cfg = state.settings?.email || {}; if(!cfg.enabled) return;
        try{ if(window.emailjs && cfg.publicKey){ window.emailjs.init(cfg.publicKey); }
          const paramsGuest={ brand: state.settings.brand||'StayStack', to_email: booking.email, guest_name: booking.name, property: property.title, from: booking.from, to: booking.to, total: booking.total, payment: booking.payment||'card' };
          const paramsManager={ brand: state.settings.brand||'StayStack', to_email: cfg.managerEmail||'', guest_name: booking.name, property: property.title, from: booking.from, to: booking.to, total: booking.total };
          if(cfg.serviceId && cfg.templateId){
            await window.emailjs.send(cfg.serviceId, cfg.templateId, paramsGuest);
            if(cfg.managerEmail) await window.emailjs.send(cfg.serviceId, cfg.templateId, paramsManager);
          }
        }catch(e){ console.warn('Email send failed', e); }
      };

      const submit=async()=>{
        if(!from||!to||!name||!email) return alert('Please complete all required fields.');
        if(conflicting) return alert('Selected dates conflict with an existing booking.');
        const booking={ id:uid('bk'), propertyId:property.id, name,email, from,to, guests,note, total, payment, status:'pending', createdAt:new Date().toISOString() };
        const notif={ id:uid('ntf'), type:'booking_request', text:`${name} requested ${property.title} (${from} → ${to}).`, createdAt:new Date().toISOString(), read:false, data:{ bookingId:booking.id } };
        setState(s=>({ ...s, bookings:[booking, ...s.bookings], notifications:[notif, ...s.notifications] }));
        close();
        setTimeout(()=> alert('Request submitted! We\'ll notify you when a manager responds.'), 30);
        sendEmails(booking);
      };

      const images = Array.isArray(property.images)? property.images: toImages(property.image);

      return (
        <div className="fixed inset-0 z-50">
          <div className="fixed inset-0 bg-black/50" onClick={close}></div>
          <div className="fixed inset-0 overflow-y-auto flex items-start justify-center p-4">
            <div className="w-full max-w-3xl bg-white rounded-2xl shadow-xl">
              {images.length>0 && (
                <ImageCarousel images={images} ratio="16 / 10" rounded="rounded-t-2xl" fit="contain"/>
              )}
              <div className="p-4">
                <div className="text-lg font-semibold">Request to book · {property.title}</div>
                <div className="text-sm text-slate-500">${property.pricePerNight}/night · {property.location}</div>

                <div className="grid md:grid-cols-2 gap-3 mt-4">
                  <div>
                    <label className="text-xs">Check-in</label>
                    <input className="w-full border rounded-lg px-3 py-2 mt-1" type="date" value={from} onChange={e=>setFrom(e.target.value)} />
                  </div>
                  <div>
                    <label className="text-xs">Check-out</label>
                    <input className="w-full border rounded-lg px-3 py-2 mt-1" type="date" value={to} onChange={e=>setTo(e.target.value)} />
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-3 mt-3 items-end">
                  <div>
                    <label className="text-xs">Guests</label>
                    <input className="w-full border rounded-lg px-3 py-2 mt-1" type="number" min="1" value={guests} onChange={e=>setGuests(Number(e.target.value||1))} />
                  </div>
                  <div className="text-sm text-slate-600">Nights: {nights}</div>
                </div>

                <div className="grid md:grid-cols-2 gap-3 mt-3">
                  <div>
                    <label className="text-xs">Your name</label>
                    <input className="w-full border rounded-lg px-3 py-2 mt-1" value={name} onChange={e=>setName(e.target.value)} />
                  </div>
                  <div>
                    <label className="text-xs">Email</label>
                    <input className="w-full border rounded-lg px-3 py-2 mt-1" type="email" value={email} onChange={e=>setEmail(e.target.value)} />
                  </div>
                </div>

                <div className="mt-3">
                  <label className="text-xs">Payment method</label>
                  <select className="w-full border rounded-lg px-3 py-2 mt-1" value={payment} onChange={e=>setPayment(e.target.value)}>
                    <option value="card">Credit/Debit Card</option>
                    <option value="cash">Cash</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div className="mt-3">
                  <label className="text-xs">Notes (optional)</label>
                  <textarea className="w-full border rounded-lg px-3 py-2 mt-1" rows="3" placeholder="Arrival time, special requests…" value={note} onChange={e=>setNote(e.target.value)}></textarea>
                </div>

                {(from&&to) && (
                  <div className="mt-3 p-3 bg-slate-50 rounded-lg text-sm">
                    <div className="font-medium">Estimated total</div>
                    <div className="text-slate-700">${total.toLocaleString()}</div>
                    <div className="text-xs mt-1">{conflicting? 'Dates unavailable' : 'No conflicts detected'}</div>
                  </div>
                )}

                <div className="mt-5 flex justify-end gap-2">
                  <button className="px-3 py-1.5 rounded-lg border" onClick={close}>Cancel</button>
                  <button className="px-3 py-1.5 rounded-lg bg-slate-900 text-white" onClick={submit}>Submit request</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }
    root.render(<BookingModal/>);
  }

  // -------------------- Top & Footer --------------------
  function TopBar({ brand, role, setRole, view, setView, unread }){
    const Tab=(v,l)=>(<button onClick={()=>setView(v)} className={`px-3 py-2 rounded-lg ${view===v?'bg-slate-900 text-white':'hover:bg-slate-100'}`}>{l}</button>);
    return (
      <div className="sticky top-0 z-30 bg-white/90 backdrop-blur border-b">
        <div className="max-w-6xl mx-auto px-4 h-14 flex items-center gap-3">
          <div className="font-semibold">{brand||'StayStack'} <span className="text-xs px-2 py-0.5 ml-1 border rounded-full">MVP</span></div>
          <div className="flex gap-2 ml-4">
            {Tab('browse','Browse')}
            {Tab('bookings','My bookings')}
            <button onClick={()=>setView('notifications')} className="px-3 py-2 rounded-lg hover:bg-slate-100">Notifications{unread>0 && <span className="ml-1 text-xs bg-slate-900 text-white px-2 py-0.5 rounded-full">{unread}</span>}</button>
            <button onClick={()=>setView('manage')} className="px-3 py-2 rounded-lg hover:bg-slate-100">Manage</button>
          </div>
          <div className="ml-auto flex items-center gap-2">
            <div className="text-sm text-slate-600">Role</div>
            <select className="border rounded-lg px-2 py-1" value={role} onChange={e=>setRole(e.target.value)}>
              <option>Guest</option>
              <option>Manager</option>
            </select>
          </div>
        </div>
      </div>
    );
  }
  function Footer({ brand }){
    return (
      <div className="border-t mt-8">
        <div className="max-w-6xl mx-auto px-4 py-6 text-sm text-slate-500 flex items-center justify-between">
          <div>© {new Date().getFullYear()} {brand||'StayStack'}</div>
          <div className="flex gap-3"><a className="hover:underline" href="#">Privacy</a><a className="hover:underline" href="#">Terms</a><a className="hover:underline" href="#">Help</a></div>
        </div>
      </div>
    );
  }

  // -------------------- Pages --------------------
  function PropertyCard({ p, onBook }){
    const imgs = Array.isArray(p.images)? p.images: toImages(p.image);
    return (
      <div className="border rounded-2xl overflow-hidden">
        {imgs[0] && <ImageCarousel images={imgs} ratio="16 / 10" fit="contain" rounded="rounded-t-2xl" />}
        <div className="p-4">
          <div className="text-base font-semibold">{p.title} · ${p.pricePerNight}/night</div>
          <div className="text-sm text-slate-500">{p.location}</div>
          <div className="mt-2 text-sm text-slate-600">{p.beds} beds · {p.baths} baths · Up to {p.maxGuests} guests</div>
          <div className="mt-2 flex flex-wrap gap-1">{safeAmen(p.amenities).map(a=> <span key={a} className="px-2 py-0.5 rounded-full border text-xs">{a}</span>)}</div>
          <div className="mt-4">
            <button className="w-full md:w-auto px-4 py-2 rounded-lg bg-slate-900 text-white" onClick={()=>onBook(p)}>Request to book</button>
          </div>
        </div>
      </div>
    );
  }

  function Browse({ state,setState }){
    return (
      <div className="grid md:grid-cols-2 gap-6">
        {state.properties.map(p=> <PropertyCard key={p.id} p={p} onBook={(property)=>openBookingDialog({state,setState,property})} />)}
      </div>
    );
  }

  function MyBookings({ state,setState }){
    return (
      <div>
        {state.bookings.length===0 && (
          <div className="p-8 text-center text-slate-600 border rounded-2xl">No bookings yet. Explore properties on the Browse tab.</div>
        )}
        {state.bookings.map(b=>{ const p=state.properties.find(x=>x.id===b.propertyId);
          return (
            <div key={b.id} className="border rounded-2xl p-4 mb-3">
              <div className="font-medium">{p?.title} · {p?.location}</div>
              <div className="text-sm text-slate-600">{b.from} → {b.to} · {b.guests} guests</div>
              <div className="text-sm mt-1">Total: ${ (b.total||0).toLocaleString() } • Status: <StatusBadge status={b.status}/></div>
              {b.status!=='cancelled' && b.status!=='declined' && (
                <div className="mt-3"><button className="px-3 py-1.5 rounded-lg border" onClick={()=> setState(s=>({...s, bookings:s.bookings.map(x=>x.id===b.id? {...x, status:'cancelled'}:x)}))}>Cancel</button></div>
              )}
            </div>
          );
        })}
      </div>
    );
  }

  function StatusBadge({ status }){
    const m={ pending:"bg-amber-100 text-amber-800", approved:"bg-green-100 text-green-800", declined:"bg-red-100 text-red-800", cancelled:"bg-slate-100 text-slate-800" };
    const cls=m[status]||"bg-slate-100 text-slate-800"; const label=(status||'').slice(0,1).toUpperCase()+(status||'').slice(1);
    return <span className={`px-2 py-0.5 rounded-full text-xs ${cls}`}>{label}</span>;
  }

  function ManagerDashboard({ state,setState }){
    const [tab,setTab]=useState('bookings');
    const tabBtn=v=> `px-3 py-1.5 rounded-lg ${tab===v? 'bg-slate-900 text-white':'hover:bg-slate-100'}`;
    return (
      <div>
        <div className="flex gap-2 mb-3">
          <button className={tabBtn('bookings')} onClick={()=>setTab('bookings')}>Bookings</button>
          <button className={tabBtn('properties')} onClick={()=>setTab('properties')}>Properties</button>
          <button className={tabBtn('requests')} onClick={()=>setTab('requests')}>Requests</button>
          <button className={tabBtn('settings')} onClick={()=>setTab('settings')}>Settings</button>
        </div>
        <div className="text-sm text-slate-500 mb-3">Demo data persists locally and in Netlify Blobs.</div>
        {tab==='bookings' && <ManagerBookings state={state} setState={setState}/>} 
        {tab==='properties' && <ManagerProperties state={state} setState={setState}/>} 
        {tab==='requests' && <ManagerRequests state={state} setState={setState}/>} 
        {tab==='settings' && <ManagerSettings state={state} setState={setState}/>} 
      </div>
    );
  }

  function ManagerBookings({ state,setState }){
    const setStatus=(id,status)=>{
      setState(s=>({...s, bookings:s.bookings.map(b=> b.id===id? {...b, status}: b)}));
      setState(s=>({...s, notifications:[{ id:uid('ntf'), type:'booking_status', text:`Booking ${id} was ${status}.`, read:false, createdAt:new Date().toISOString(), data:{ bookingId:id } }, ...s.notifications]}));
    };
    return (
      <div>
        {state.bookings.length===0 && (
          <div className="p-8 text-center text-slate-600 border rounded-2xl">
            No booking requests yet<br/>When guests submit a request, it will appear here.
          </div>
        )}
        {state.bookings.map(b=>{ const p=state.properties.find(x=>x.id===b.propertyId);
          return (
            <div key={b.id} className="border rounded-2xl p-4 mb-3">
              <div className="font-medium">{p?.title} · {p?.location}</div>
              <div className="text-sm text-slate-600">Guest: {b.name} ({b.email})</div>
              <div className="text-sm">{b.from} → {b.to} • {b.guests} guests • Total ${ (b.total||0).toLocaleString() } • Status: <StatusBadge status={b.status}/></div>
              {b.note && <div className="mt-1 italic text-slate-600">“{b.note}”</div>}
              <div className="text-xs text-slate-500 mt-1">ID: {b.id}</div>
              <div className="mt-3 flex gap-2">
                <button className="px-3 py-1.5 rounded-lg border" onClick={()=>setStatus(b.id,'declined')}>Decline</button>
                <button className="px-3 py-1.5 rounded-lg border" onClick={()=>setStatus(b.id,'approved')}>Approve</button>
              </div>
            </div>
          );
        })}
      </div>
    );
  }

  function ManagerProperties({ state,setState }){
    const initial={ title:'', location:'', beds:1, baths:1, maxGuests:2, pricePerNight:100, amenities:'Wi-Fi', images:[], image:'', imageName:'', description:'' };
    const [form,setForm]=useState(initial);
    const [editId,setEditId]=useState(null);
    const maxImages=10;

    const onUploadImages=async(e)=>{
      const files=Array.from(e.target.files||[]);
      const remaining=Math.max(0, maxImages-(form.images?.length||0));
      const take=files.slice(0,remaining); const urls=[];
      for(const f of take){ const max=4*1024*1024; if(f.size>max){ alert(`${f.name} too large (max 4MB).`); continue; } const dataUrl=await readFileAsDataURL(f); urls.push(String(dataUrl)); }
      setForm(v=>({...v, images:[...(v.images||[]), ...urls]})); e.target.value='';
    };
    const importFromUrls=()=>{ const raw=prompt('Paste 1 or more image URLs (one per line):','https://…'); if(!raw) return; const lines=raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const remaining=Math.max(0, maxImages-(form.images?.length||0)); setForm(v=>({...v, images:[...(v.images||[]), ...lines.slice(0,remaining)]})); };
    const setCover=(idx)=> setForm(v=>{ const arr=[...(v.images||[])]; const [item]=arr.splice(idx,1); arr.unshift(item); return {...v, images:arr}; });
    const removeImg=(idx)=> setForm(v=>({...v, images:(v.images||[]).filter((_,i)=>i!==idx)}));
    const move=(idx,dir)=> setForm(v=>{ const arr=[...(v.images||[])]; const j=idx+dir; if(j<0||j>=arr.length) return v; [arr[idx],arr[j]]=[arr[j],arr[idx]]; return {...v, images:arr}; });

    const startEdit=(p)=>{ setEditId(p.id); setForm({ title:p.title||'', location:p.location||'', beds:p.beds??1, baths:p.baths??1, maxGuests:p.maxGuests??2, pricePerNight:p.pricePerNight??100, amenities:Array.isArray(p.amenities)? p.amenities.join(', '):(p.amenities||'Wi-Fi'), images:Array.isArray(p.images)? [...p.images]: toImages(p.image), image:p.image||'', imageName:'', description:p.description||'' }); try{ window.scrollTo({top:0,behavior:'smooth'});}catch{} };
    const resetForm=()=>{ setForm(initial); setEditId(null); };

    const submit=()=>{
      if(!form.title||!form.location) return alert('Title and location are required');
      const images=Array.isArray(form.images) && form.images.length? form.images: toImages(form.image);
      const record={ ...form, beds:Number(form.beds), baths:Number(form.baths), maxGuests:Number(form.maxGuests), pricePerNight:Number(form.pricePerNight), amenities:toAmen(form.amenities), images, image:images[0]||'' };
      if(editId){ setState(s=>({ ...s, properties:s.properties.map(p=> p.id===editId? {...p, ...record, id:editId}:p) })); }
      else { const p={ ...record, id:uid('p') }; setState(s=>({ ...s, properties:[p, ...s.properties] })); }
      resetForm();
    };
    const remove=(id)=>{ if(!confirm('Remove this property?')) return; setState(s=>({ ...s, properties:s.properties.filter(p=>p.id!==id), bookings:s.bookings.filter(b=>b.propertyId!==id) })); if(editId===id) resetForm(); };

    const isEditing=!!editId;

    return (
      <div className="grid md:grid-cols-2 gap-6">
        <div className="border rounded-2xl">
          <div className="p-4 border-b">
            <div className="text-base font-semibold">{isEditing? 'Edit property':'Add property'}</div>
            <div className="text-sm text-slate-500">Upload up to 10 images (reorder, set cover). Enter amenities separated by commas.</div>
          </div>
          <div className="p-4 space-y-3">
            <div className="grid grid-cols-2 gap-3">
              <div><label className="text-xs">Title</label><input className="w-full border rounded-lg px-3 py-2 mt-1" value={form.title} onChange={e=>setForm({...form, title:e.target.value})}/></div>
              <div><label className="text-xs">Location</label><input className="w-full border rounded-lg px-3 py-2 mt-1" value={form.location} onChange={e=>setForm({...form, location:e.target.value})}/></div>
            </div>
            <div className="grid grid-cols-4 gap-3">
              <div><label className="text-xs">Beds</label><input type="number" min="0" className="w-full border rounded-lg px-3 py-2 mt-1" value={form.beds} onChange={e=>setForm({...form, beds:e.target.value})}/></div>
              <div><label className="text-xs">Baths</label><input type="number" min="0" className="w-full border rounded-lg px-3 py-2 mt-1" value={form.baths} onChange={e=>setForm({...form, baths:e.target.value})}/></div>
              <div><label className="text-xs">Max guests</label><input type="number" min="1" className="w-full border rounded-lg px-3 py-2 mt-1" value={form.maxGuests} onChange={e=>setForm({...form, maxGuests:e.target.value})}/></div>
              <div><label className="text-xs">Price/night ($)</label><input type="number" min="0" className="w-full border rounded-lg px-3 py-2 mt-1" value={form.pricePerNight} onChange={e=>setForm({...form, pricePerNight:e.target.value})}/></div>
            </div>
            <div className="grid grid-cols-2 gap-3 items-end">
              <div>
                <label className="text-xs">Upload images (max 10)</label>
                <input type="file" accept="image/*" multiple className="w-full border rounded-lg px-3 py-2 mt-1" onChange={onUploadImages}/>
                <button className="mt-2 px-2 py-1 rounded-md border text-[10px]" onClick={importFromUrls}>Import from URLs</button>
              </div>
              <div>
                <label className="text-xs">Legacy single image URL (optional)</label>
                <input className="w-full border rounded-lg px-3 py-2 mt-1" placeholder="https://…" value={form.image} onChange={e=>setForm({...form, image:e.target.value})}/>
              </div>
            </div>
            {(form.images?.length>0) && (
              <div>
                <label className="text-xs">Images (first = cover)</label>
                <div className="mt-2 flex flex-wrap gap-3">
                  {form.images.map((src,idx)=> (
                    <div key={src+idx} className="flex flex-col items-center gap-1">
                      <div className="h-16 w-24 rounded-lg bg-cover bg-center border" style={{backgroundImage:`url(${src})`}} title={src}></div>
                      <div className="flex gap-1">
                        <button className="px-2 py-1 rounded-md border text-[10px]" onClick={()=>move(idx,-1)}>←</button>
                        <button className="px-2 py-1 rounded-md border text-[10px]" onClick={()=>move(idx,1)}>→</button>
                        <button className="px-2 py-1 rounded-md border text-[10px]" onClick={()=>setCover(idx)}>Cover</button>
                        <button className="px-2 py-1 rounded-md border text-[10px]" onClick={()=>removeImg(idx)}>Remove</button>
                      </div>
                      {idx===0 && <div className="text-[10px] text-slate-500">cover</div>}
                    </div>
                  ))}
                </div>
              </div>
            )}
            <div>
              <label className="text-xs">Amenities (comma separated)</label>
              <input className="w-full border rounded-lg px-3 py-2 mt-1" value={form.amenities} onChange={e=>setForm({...form, amenities:e.target.value})}/>
            </div>
            <div>
              <label className="text-xs">Description</label>
              <textarea className="w-full border rounded-lg px-3 py-2 mt-1" rows="3" value={form.description} onChange={e=>setForm({...form, description:e.target.value})}></textarea>
            </div>
          </div>
          <div className="p-4 border-t flex justify-end gap-2">
            {isEditing && <button className="px-3 py-1.5 rounded-lg border" onClick={resetForm}>Cancel</button>}
            <button className="px-3 py-1.5 rounded-lg bg-slate-900 text-white" onClick={submit}>{isEditing? 'Save changes':'Add listing'}</button>
          </div>
        </div>

        <div className="space-y-3">
          {state.properties.map(p=> (
            <div key={p.id} className="border rounded-2xl">
              <div className="p-4 border-b">
                <div className="text-base font-semibold">{p.title} · ${p.pricePerNight}/night</div>
                <div className="text-sm text-slate-500">{p.location} • {p.beds} bd / {p.baths} ba • {p.maxGuests} guests</div>
              </div>
              <div className="p-4 text-sm text-slate-600">
                {(p.images?.[0]) && (<div className="mb-3 w-full rounded-lg border overflow-hidden" style={{aspectRatio: "16 / 10"}}><img src={p.images[0]} alt="" className="w-full h-full object-contain"/></div>)}
                <div className="line-clamp-2">{p.description}</div>
                <div className="mt-2 flex flex-wrap gap-1">{safeAmen(p.amenities).map(a=> <span key={a} className="px-2 py-0.5 rounded-full border text-xs">{a}</span>)}</div>
                {(p.images?.length>1) && (
                  <div className="mt-3 flex flex-wrap gap-2">
                    {p.images.slice(1,6).map((src,i)=> (<div key={src+i} className="h-10 w-16 rounded-md bg-cover bg-center border" style={{backgroundImage:`url(${src})`}}></div>))}
                  </div>
                )}
              </div>
              <div className="p-4 border-t flex justify-end gap-2">
                <button className="px-3 py-1.5 rounded-lg border" onClick={()=>startEdit(p)}>Edit</button>
                <button className="px-3 py-1.5 rounded-lg border text-red-600" onClick={()=>remove(p.id)}>Remove</button>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  function ManagerRequests({ state,setState }){
    const [form,setForm]=useState({ propertyId: state.properties[0]?.id || '', type:'maintenance', message:'Leaky faucet in kitchen.' });
    const add=()=>{ if(!form.propertyId||!form.message) return alert('Property and message required'); const req={ id:uid('rq'), ...form, status:'open', createdAt:new Date().toISOString() }; setState(s=>({...s, requests:[req, ...s.requests], notifications:[{ id:uid('ntf'), type:'maintenance', text:`New ${form.type} request at ${state.properties.find(p=>p.id===form.propertyId)?.title}.`, read:false, createdAt:new Date().toISOString(), data:{ requestId:req.id } }, ...s.notifications]})); setForm({ propertyId: state.properties[0]?.id || '', type:'maintenance', message:'' }); };
    const setStatus=(id,status)=> setState(s=>({...s, requests:s.requests.map(r=> r.id===id? {...r, status}: r)}));
    return (
      <div>
        <div className="border rounded-2xl p-4 mb-4">
          <div className="font-medium">Log a request</div>
          <div className="text-sm text-slate-500 mb-2">Track maintenance and guest messages.</div>
          <div className="grid md:grid-cols-3 gap-2">
            <select className="border rounded-lg px-3 py-2" value={form.propertyId} onChange={e=>setForm({...form, propertyId:e.target.value})}>
              {state.properties.map(p=> <option key={p.id} value={p.id}>{p.title}</option>)}
            </select>
            <select className="border rounded-lg px-3 py-2" value={form.type} onChange={e=>setForm({...form, type:e.target.value})}>
              <option value="maintenance">Maintenance</option>
              <option value="guest">Guest</option>
              <option value="other">Other</option>
            </select>
            <button className="px-3 py-2 rounded-lg bg-slate-900 text-white" onClick={add}>Add</button>
          </div>
          <textarea className="w-full border rounded-lg px-3 py-2 mt-2" rows="2" placeholder="Details…" value={form.message} onChange={e=>setForm({...form, message:e.target.value})}></textarea>
        </div>

        {state.requests.length===0 && (
          <div className="p-8 text-center text-slate-600 border rounded-2xl">No requests<br/>New items will appear here.</div>
        )}
        {state.requests.map(r=>{ const p=state.properties.find(x=>x.id===r.propertyId); return (
          <div key={r.id} className="border rounded-2xl p-4 mb-3">
            <div className="font-medium">{r.type[0].toUpperCase()+r.type.slice(1)} · {p?.title}</div>
            <div className="text-xs text-slate-500">{new Date(r.createdAt).toLocaleString()}</div>
            <div className="mt-1">{r.message}</div>
            <div className="mt-2">Status: <span className="px-2 py-0.5 rounded-full border text-xs">{r.status}</span></div>
            <div className="mt-2 flex gap-2"><button className="px-3 py-1.5 rounded-lg border" onClick={()=>setStatus(r.id,'open')}>Open</button><button className="px-3 py-1.5 rounded-lg border" onClick={()=>setStatus(r.id,'closed')}>Close</button></div>
          </div>
        );})}
      </div>
    );
  }

  function ManagerSettings({ state,setState }){
    const [brand,setBrand]=useState(state.settings.brand||'');
    const [emailCfg,setEmailCfg]=useState(state.settings.email||{ enabled:false, publicKey:'', serviceId:'', templateId:'', managerEmail:'' });
    const [smsCfg,setSmsCfg]=useState(state.settings.sms||{ enabled:false, managerPhone:'' });

    const save=()=> setState(s=>({...s, settings:{ ...s.settings, brand, email:emailCfg, sms:smsCfg }}));

    // backup/restore helpers
    const downloadJSON=(filename,data)=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1200); };
    const importBackupFile=async(file)=>{ try{ const text=await file.text(); const obj=JSON.parse(text); setState(s=>({...s, ...obj})); alert('Backup imported.'); }catch{ alert('Could not import this file.'); } };

    return (
      <div className="space-y-4">
        <div className="border rounded-2xl p-4">
          <div className="text-base font-semibold">Branding</div>
          <div className="mt-2">Site name shown in the top-left and footer.</div>
          <input className="mt-2 w-full border rounded-lg px-3 py-2" value={brand} onChange={e=>setBrand(e.target.value)} placeholder="StayStack"/>
          <div className="mt-3"><button className="px-3 py-1.5 rounded-lg bg-slate-900 text-white" onClick={save}>Save</button></div>
        </div>

        <div className="border rounded-2xl p-4">
          <div className="text-base font-semibold">Email (optional)</div>
          <div className="text-sm text-slate-500">Uses EmailJS (Client-side). Leave disabled if you haven't configured your EmailJS account.</div>
          <label className="flex items-center gap-2 mt-2"><input type="checkbox" checked={emailCfg.enabled} onChange={e=>setEmailCfg({...emailCfg, enabled:e.target.checked})}/> Enable EmailJS</label>
          <div className="grid md:grid-cols-2 gap-3 mt-2">
            <input className="border rounded-lg px-3 py-2" placeholder="Public key" value={emailCfg.publicKey} onChange={e=>setEmailCfg({...emailCfg, publicKey:e.target.value})}/>
            <input className="border rounded-lg px-3 py-2" placeholder="Service ID" value={emailCfg.serviceId} onChange={e=>setEmailCfg({...emailCfg, serviceId:e.target.value})}/>
            <input className="border rounded-lg px-3 py-2" placeholder="Template ID" value={emailCfg.templateId} onChange={e=>setEmailCfg({...emailCfg, templateId:e.target.value})}/>
            <input className="border rounded-lg px-3 py-2" placeholder="Manager email (optional)" value={emailCfg.managerEmail} onChange={e=>setEmailCfg({...emailCfg, managerEmail:e.target.value})}/>
          </div>
          <div className="mt-3"><button className="px-3 py-1.5 rounded-lg border" onClick={save}>Save</button></div>
        </div>

        <div className="border rounded-2xl p-4">
          <div className="text-base font-semibold">SMS (optional)</div>
          <div className="text-sm text-slate-500">Sends texts via a Netlify Function + Twilio (server-side). Enable only after setting Twilio env vars in Netlify.</div>
          <label className="flex items-center gap-2 mt-2">
            <input type="checkbox" checked={!!smsCfg.enabled} onChange={e=>setSmsCfg({...smsCfg, enabled:e.target.checked})}/>
            Enable SMS
          </label>
          <div className="grid md:grid-cols-2 gap-3 mt-2">
            <input className="border rounded-lg px-3 py-2" placeholder="Manager phone (E.164, e.g. +12025550123)" value={smsCfg.managerPhone||''} onChange={e=>setSmsCfg({...smsCfg, managerPhone:e.target.value})}/>
          </div>
          <div className="mt-3"><button className="px-3 py-1.5 rounded-lg border" onClick={save}>Save</button></div>
        </div>

        <div className="border rounded-2xl p-4">
          <div className="text-base font-semibold">Backup & Restore</div>
          <div className="text-sm text-slate-500">Export your data before redeploys. Import to restore.</div>
          <div className="mt-3 flex items-center gap-2">
            <button className="px-3 py-1.5 rounded-lg border" onClick={()=>downloadJSON(`staystack-backup-${new Date().toISOString().slice(0,10)}.json`, state)}>Export data</button>
            <label className="px-3 py-1.5 rounded-lg border cursor-pointer">Import data
              <input type="file" accept="application/json" className="hidden" onChange={(e)=>{ const f=e.target.files?.[0]; if(f) importBackupFile(f); e.target.value=''; }}/>
            </label>
            <button className="ml-auto px-3 py-1.5 rounded-lg border" onClick={()=>{ if(confirm('Reset all demo data?')) setState(DEFAULT_STATE); }}>Reset demo data</button>
          </div>
        </div>
      </div>
    );
  }

  function Notifications({ state,setState }){ Notifications({ state,setState }){
    const unread = state.notifications.filter(n=>!n.read).length;
    const markAll=()=> setState(s=>({...s, notifications:s.notifications.map(n=>({...n, read:true})) }));
    return (
      <div>
        <div className="flex items-center gap-2 mb-3"><div className="font-medium">Notifications</div>{unread>0 && <button className="px-2 py-1 text-xs rounded-lg border" onClick={markAll}>Mark all read</button>}</div>
        {state.notifications.length===0 && <div className="p-8 border rounded-2xl text-center text-slate-600">No notifications yet.</div>}
        {state.notifications.map(n=> (
          <div key={n.id} className="border rounded-2xl p-3 mb-2 flex items-start gap-2">
            <div className={`mt-1 h-2 w-2 rounded-full ${n.read?'bg-slate-200':'bg-slate-900'}`}></div>
            <div>
              <div className="text-sm">{n.text}</div>
              <div className="text-xs text-slate-500">{new Date(n.createdAt).toLocaleString()}</div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  // -------------------- App --------------------
  function App(){
    const [state,setState]=useState(()=>{
      try{ const v=JSON.parse(localStorage.getItem(LS_KEY)||'null'); if(v) return { ...DEFAULT_STATE, ...v }; }catch{}
      return DEFAULT_STATE;
    });

    // LocalStorage save
    useEffect(()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch{} }, [state]);

    // Cloud: LOAD once from Netlify Blobs (safe merge)
    useEffect(()=>{ (async()=>{ try{ const r=await fetch(REMOTE_URL, {cache:'no-store'}); if(!r.ok) return; const cloud=await r.json().catch(()=>null); if(cloud && typeof cloud==='object' && Object.keys(cloud).length){ setState(s=>({ ...s,
      properties: Array.isArray(cloud.properties)? cloud.properties : s.properties,
      bookings:   Array.isArray(cloud.bookings)  ? cloud.bookings  : s.bookings,
      notifications: Array.isArray(cloud.notifications)? cloud.notifications : s.notifications,
      requests:   Array.isArray(cloud.requests)  ? cloud.requests  : (s.requests||[]),
      settings:   cloud.settings && typeof cloud.settings==='object' ? { ...s.settings, ...cloud.settings } : s.settings
    })); } }catch(e){} })(); }, []);

    // Cloud: SAVE whenever data changes (debounced)
    useEffect(()=>{
      const payload={ properties:state.properties, bookings:state.bookings, notifications:state.notifications, requests:state.requests||[], settings:state.settings };
      const t=setTimeout(()=>{ fetch(REMOTE_URL, { method:'PUT', headers:{'content-type':'application/json'}, body:JSON.stringify(payload) }).catch(()=>{}); }, 400);
      return ()=>clearTimeout(t);
    }, [state.properties, state.bookings, state.notifications, state.requests, state.settings]);

    const unread=state.notifications.filter(n=>!n.read).length;

    const [view,setView]=useState(state.view||'browse');
    useEffect(()=> setState(s=>({...s, view})), [view]);

    return (
      <div>
        <TopBar brand={state.settings.brand} role={state.role} setRole={(r)=>setState(s=>({...s, role:r}))} view={view} setView={setView} unread={unread}/>
        <div className="max-w-6xl mx-auto px-4 py-6">
          {view==='browse' && <Browse state={state} setState={setState}/>} 
          {view==='bookings' && <MyBookings state={state} setState={setState}/>} 
          {view==='manage' && (state.role==='Manager'? <ManagerDashboard state={state} setState={setState}/> : <NeedManager/>)}
          {view==='notifications' && <Notifications state={state} setState={setState}/>} 
        </div>
        <Footer brand={state.settings.brand}/>
      </div>
    );
  }

  function NeedManager(){
    return (
      <div className="p-8 text-center border rounded-2xl">
        <div className="text-lg font-semibold mb-1">Manager access required</div>
        <div className="text-slate-600">Switch your role to Manager in the top bar to view the dashboard. This demo supports both guest and manager flows.</div>
      </div>
    );
  }

  const container=document.getElementById('app');
  ReactDOM.createRoot(container).render(<App/>);
  </script>
</body>
</html>
